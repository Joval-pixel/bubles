const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
canvas.width = innerWidth;
canvas.height = innerHeight;

let bolhas = [];

function carregar(tipo) {
  let url = "";
  if (tipo === "acoes") {
    url = "https://brapi.dev/api/quote/list?sortBy=volume&sortOrder=desc&limit=60&token=5bTDfSmR2ieax6y7JUqDAD";
  } else if (tipo === "criptos") {
    url = "https://brapi.dev/api/crypto?limit=60&token=5bTDfSmR2ieax6y7JUqDAD";
  } else if (tipo === "opcoes") {
    url = "https://brapi.dev/api/quote/list?sortBy=volume&sortOrder=desc&limit=60&search=CALL&token=5bTDfSmR2ieax6y7JUqDAD";
  }

  fetch(url)
    .then(res => res.json())
    .then(data => {
      const ativos = data.stocks || data.coins || [];
      bolhas = ativos.map(a => ({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        vx: (Math.random() - 0.5) * 0.8,
        vy: (Math.random() - 0.5) * 0.8,
        r: 40,
        code: a.symbol || a.coin || "",
        pct: a.changePercent?.toFixed(2) || a.change?.toFixed(2) || "0",
        logo: a.logo || a.image || "",
        up: (a.changePercent || a.change || 0) >= 0
      }));
    });
}

function evitarColisao() {
  for (let i = 0; i < bolhas.length; i++) {
    for (let j = i + 1; j < bolhas.length; j++) {
      const a = bolhas[i];
      const b = bolhas[j];
      const dx = b.x - a.x;
      const dy = b.y - a.y;
      const dist = Math.hypot(dx, dy);
      const minDist = a.r + b.r;

      if (dist < minDist) {
        const angle = Math.atan2(dy, dx);
        const overlap = minDist - dist;
        const moveX = Math.cos(angle) * (overlap / 2);
        const moveY = Math.sin(angle) * (overlap / 2);

        a.x -= moveX;
        a.y -= moveY;
        b.x += moveX;
        b.y += moveY;
      }
    }
  }
}

function desenharBolhas() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  evitarColisao();

  for (const b of bolhas) {
    // movimento
    b.x += b.vx;
    b.y += b.vy;

    // colisão com bordas
    if (b.x - b.r < 0 || b.x + b.r > canvas.width) b.vx *= -1;
    if (b.y - b.r < 0 || b.y + b.r > canvas.height) b.vy *= -1;

    // bolha
    ctx.beginPath();
    ctx.arc(b.x, b.y, b.r, 0, 2 * Math.PI);
    ctx.fillStyle = b.up ? "#008000" : "#cc0000"; // verde escuro e vermelho vivo
    ctx.shadowColor = "white";
    ctx.shadowBlur = 6;
    ctx.fill();
    ctx.lineWidth = 2;
    ctx.strokeStyle = "white";
    ctx.stroke();

    // logo
    if (b.logo) {
      const img = new Image();
      img.src = b.logo;
      ctx.save();
      ctx.beginPath();
      ctx.arc(b.x, b.y - 10, 12, 0, Math.PI * 2, true);
      ctx.clip();
      ctx.drawImage(img, b.x - 12, b.y - 22, 24, 24);
      ctx.restore();
    }

    // código da ação
    ctx.fillStyle = "white";
    ctx.font = "bold 11px Arial";
    ctx.textAlign = "center";
    ctx.fillText(b.code, b.x, b.y + 5);

    // variação
    ctx.fillStyle = "white";
    ctx.font = "bold 14px Arial";
    ctx.fillText((b.pct > 0 ? "+" : "") + b.pct + "%", b.x, b.y + 22);
  }
}

function animar() {
  desenharBolhas();
  requestAnimationFrame(animar);
}

carregar("acoes");
animar();