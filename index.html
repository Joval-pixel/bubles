<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>BUBLES — Ações ao Vivo</title>
  <link rel="stylesheet" href="/style.css" />

  <style>
    /* Badge "online agora" */
    .online-badge {
      position: fixed;
      bottom: 16px;
      right: 16px;
      padding: 10px 14px;
      border-radius: 999px;
      box-shadow: 0 6px 18px rgba(0,0,0,.15);
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      font-size: 14px;
      background: #111;
      color: #fff;
      display: flex; align-items: center; gap: 8px;
      z-index: 1000;
    }
    .online-badge .dot {
      width: 10px; height: 10px; border-radius: 50%;
      background: #22c55e; /* verde */
      box-shadow: 0 0 10px rgba(34,197,94,.6);
      flex: 0 0 auto;
    }
    @media (max-width: 480px) {
      .online-badge { font-size: 13px; padding: 9px 12px; bottom: 12px; right: 12px; }
    }
  </style>
</head>
<body>
  <!-- Header / Controles -->
  <header class="header">
    <div class="brand">
      <span class="dot"></span>
      <strong>BUBLES</strong> — Ações ao Vivo
    </div>

    <div class="buttons" role="tablist" aria-label="Categorias">
      <button type="button" class="btn active" data-cat="acoes">Ações</button>
      <button type="button" class="btn" data-cat="petroleo">Petróleo</button>
      <button type="button" class="btn" data-cat="bancos">Bancos</button>
      <button type="button" class="btn" data-cat="varejo">Varejo</button>
    </div>

    <div id="statusBar" class="status">Carregando…</div>
  </header>

  <!-- Palco das bolhas -->
  <canvas id="bubbleCanvas" aria-hidden="true"></canvas>

  <!-- Badge de visitantes online -->
  <div id="online-counter" class="online-badge" aria-live="polite">
    <span class="dot" aria-hidden="true"></span>
    <span><strong id="online-number">--</strong> online agora</span>
  </div>

  <script src="/script.js"></script>

  <!-- Script do contador -->
  <script>
    (function () {
      // Gera/recupera um ID de sessão persistente por navegador
      function getSessionId() {
        try {
          const key = "online:sessionId";
          let sid = localStorage.getItem(key);
          if (!sid) {
            sid = (crypto.randomUUID && crypto.randomUUID()) ||
                  (Date.now() + "-" + Math.random().toString(16).slice(2));
            localStorage.setItem(key, sid);
          }
          return sid;
        } catch { // Safari privado etc.
          return Date.now() + "-" + Math.random().toString(16).slice(2);
        }
      }

      const sessionId = getSessionId();
      const API = "/api/online";
      const numberEl = document.getElementById("online-number");

      async function ping(post = true) {
        try {
          const res = await fetch(API, {
            method: post ? "POST" : "GET",
            headers: { "Content-Type": "application/json" },
            body: post ? JSON.stringify({ sessionId }) : undefined,
            cache: "no-store",
          });
          const data = await res.json();
          if (typeof data.online === "number") numberEl.textContent = data.online;
        } catch { /* silencioso */ }
      }

      // Atualiza imediatamente e mantém presença
      ping(false);
      ping(true);
      setInterval(() => ping(true), 20_000); // envia presença a cada 20s
    })();
  </script>
</body>
</html>
