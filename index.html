<script>
  (function () {
    function getSessionId() {
      try {
        const key = "online:sessionId";
        let sid = localStorage.getItem(key);
        if (!sid) {
          sid = (crypto.randomUUID && crypto.randomUUID()) ||
                (Date.now() + "-" + Math.random().toString(16).slice(2));
          localStorage.setItem(key, sid);
        }
        return sid;
      } catch {
        return Date.now() + "-" + Math.random().toString(16).slice(2);
      }
    }

    const sessionId = getSessionId();
    const API = `${location.origin}/api/online`; // URL absoluta
    const numberEl = document.getElementById("online-number");

    async function call(method, body) {
      const res = await fetch(API, {
        method,
        headers: body ? { "Content-Type": "application/json" } : undefined,
        body: body ? JSON.stringify(body) : undefined,
        cache: "no-store",
      });
      if (!res.ok) {
        const txt = await res.text().catch(() => "");
        throw new Error(`API ${method} ${res.status}: ${txt || res.statusText}`);
      }
      return res.json();
    }

    async function update(post = false) {
      try {
        const data = await call(post ? "POST" : "GET", post ? { sessionId } : undefined);
        if (typeof data.online === "number") {
          numberEl.textContent = data.online;
        }
      } catch (err) {
        console.warn("[online-counter]", err);
        // fallback visual para não ficar “—”
        if (numberEl.textContent.trim() === "—" || numberEl.textContent.trim() === "--") {
          numberEl.textContent = "0";
        }
      }
    }

    // Primeiro tenta só ler (GET), depois mantém presença (POST)
    update(false);
    update(true);
    setInterval(() => update(true), 20_000);
  })();
</script>
